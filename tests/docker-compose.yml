services:
  urlflatine:
    build:
      context: ..
      dockerfile: tests/Dockerfile.test
    ports:
      - "8080:8080"
    environment:
      - LISTEN_HOST=0.0.0.0
      - LISTEN_PORT=8080
      - RUST_LOG=debug
    networks:
      - test-network
    depends_on:
      - static-server

  # Simple HTTP server to serve our example file
  static-server:
    image: halverneus/static-file-server:latest
    ports:
      - "8000:8000"
    environment:
      - PORT=8000
      - FOLDER=/var/www
    volumes:
      - ./example_asset.txt:/var/www/example_asset.txt
    networks:
      - test-network

  # Dredd for API testing
  dredd:
    image: apiaryio/dredd:latest
    volumes:
      - ../openapi.yaml:/app/openapi.yaml:ro
      - ./dredd-hooks.js:/app/dredd-hooks.js:ro
    # Use dredd command explicitly
    command: ["dredd", "/app/openapi.yaml", "http://urlflatine:8080", "--hookfiles=/app/dredd-hooks.js", "--language=nodejs"]
    networks:
      - test-network
    depends_on:
      - urlflatine
      - static-server

networks:
  test-network:
    driver: bridge

# To run tests and automatically stop all services when Dredd finishes:
# docker-compose up --build --abort-on-container-exit --exit-code-from dredd